name: Auto-Sync and Build Protected Extensions

concurrency:
  group: "build"
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 21 * * *' # 4 AM WIB daily
  workflow_dispatch:

jobs:
  sync-inject-build:
    name: Sync, Protect, and Build
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout THIS Repo (contains injector.py)
      - name: Checkout Tools
        uses: actions/checkout@v4.2.2
        with:
          path: "tools"

      # 2. Checkout UPSTREAM Repo (duro92/ExtCloud source code)
      - name: Checkout Upstream Source
        uses: actions/checkout@v4.2.2
        with:
          repository: duro92/ExtCloud
          path: "src"

      # 3. Setup Python for Injector
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 4. Inject Protection
      - name: Inject License Checks
        run: |
          cp tools/injector.py src/
          cd src
          python injector.py

      # 5. Setup JDK 21 (MUST match upstream requirement)
      - name: Setup JDK 21
        uses: actions/setup-java@v4.6.0
        with:
          distribution: "adopt"
          java-version: 21

      # 6. Setup Android SDK (required for CloudStream builds)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.2

      # 7. Create local.properties (required by Gradle)
      - name: Create local.properties
        run: |
          cd src
          echo "# Auto-generated" > local.properties

      # 8. Build Plugins
      - name: Build Plugins
        run: |
          cd src
          chmod +x gradlew
          ./gradlew make

      # 9. Upload Artifacts
      - name: Upload Protected Extensions
        uses: actions/upload-artifact@v4
        with:
          name: Protected-Extensions
          path: "src/**/build/*.cs3"
